{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Map of Puerto Rico</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body class="{% if not light_mode %}dark-mode{% endif %}">
    <div class="navbar">
        <img src="{% static 'images/rcmi.webp' %}" alt="Company Logo" class="logo">
        <img src="{% static 'images/aim_ahead_600x474.webp' %}" alt="Sponsor Logo" class="logo">
    </div>

    <div class="title-section">
        {% comment %} <h1>Cardiovascular and Liver Disease in Puerto Rico</h1> {% endcomment %}
        <h1>Cardiovascular Risk in Puerto Rico</h1>
        <button class="toggle-button" onclick="toggleMode()">
            <i id="toggle-icon" class="{% if not light_mode %}fas fa-sun{% else %}fas fa-moon{% endif %}"></i>
        </button>
    </div>

    <div class="main-container">
        <aside class="sidebar">
            <h2>Explore Concepts</h2>
            {% comment %} <div class="dropdown-group">
            <label for="disease">Select Disease Type</label>
            <select id="disease" name="disease">
                <option value="" disabled selected>Select a disease</option>
                <option value="cardiovascular">Cardiovascular Disease</option>
                <option value="liver">Liver Disease</option>
            </select>
            </div> {% endcomment %}
            <div class="dropdown-group">
            <label for="sdoh">Select Social Determinant of Health</label>
            <select id="sdoh" name="sdoh">
                <option value="" disabled selected>Select an indicator</option>
                <option value="access_healthcare">Access to Healthcare</option>
                <option value="income_levels">Income Levels</option>
                <option value="education">Education Level</option>
                <option value="housing">Housing Stability</option>
                <option value="food_security">Food Security</option>
            </select>
            </div>
            <div class="dropdown-group">
                <label for="metric">Select Metric</label>
                <select id="metric" name="metric">
                    {% for item in metrics_for_dropdown %}
                    <option value="{{ item.key }}" 
                            data-description="{{ item.description|escapejs }}"
                            {% if forloop.first %}selected{% endif %}>
                        {{ item.display_name }}
                    </option>
                    {% endfor %}
                </select>
                <!-- New area for metric description -->
                <div id="metric-option-description" class="metric-option-description">
                    <!-- Description will be populated by JavaScript -->
                </div>
            </div>
        </aside>

        <!-- New wrapper for map and legend -->
        <div class="map-legend-area">
            <div id="map"></div> <!-- Map will be initialized here -->

            <!-- Legend Section -->
            <aside class="scale-section">
                <!-- Optional: You can add a title for the legend if desired -->
                {% comment %} <h3 style="text-align: center; width: 100%; margin-bottom: 10px;">Legend</h3> {% endcomment %}
                <div class="scale-container">
                    <!-- Color boxes will be generated here by JavaScript -->
                </div>
                <div class="scale-labels">
                    <!-- Labels for the scale will be generated here by JavaScript -->
                </div>
            </aside>
        </div>
    </div>

    <!-- Info box moved outside main-container, typically below the map/sidebar area -->
    <div id="info-box" class="info-box">
        <h3>Municipality Info</h3>
        <div>Select a municipality on the map to see details here.</div>
    </div>

    <footer>
        <p>© 2024 Cardio and Liver Labs Disease. Created with Leaflet and Django by Luis F. Velazquez Sosa.</p>
    </footer>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Parse context data
        const shapes = JSON.parse('{{ muni_geojson|escapejs }}');
        const riskMap = JSON.parse('{{ risk_map|escapejs }}');
        const isLight = {{ light_mode|lower }};

        // Initialize map
        const map = L.map('map').setView([18.1208, -66.2601], 9); // Centered on Puerto Rico
        const tileUrl = isLight
            ? 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
            : 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        L.tileLayer(tileUrl, { maxZoom: 9 }).addTo(map);

        // Prepare metric selection
        const metricSelect = document.getElementById('metric');
        let selectedMetric = metricSelect.value;

        // Color bins and thresholds
        const colors = ['#FFFFCC','#FFEDA0','#FED976','#FEB24C','#FD8D3C','#FC4E2A','#E31A1C','#BD0026','#800026'];
        let thresholds = [];

        function computeThresholds(values) {
            const sorted = values.slice().sort((a,b)=>a-b);
            if (sorted.length === 0) { // Handle empty values case
                return colors.slice(1).map(() => 0);
            }
            return colors.slice(1).map((_,i) => sorted[Math.floor(sorted.length*(i+1)/colors.length)] || 0);
        }

        function getMetricValues(metric) {
            return shapes.features
                .map(f => riskMap[f.properties.NAME]?.[metric])
                .filter(v => typeof v === 'number');
        }

        function getColor(val) {
            if (typeof val !== 'number' || thresholds.length === 0) return colors[0]; // Default if no value or no thresholds
            for (let i = thresholds.length-1; i >= 0; i--) {
                if (val > thresholds[i]) return colors[i+1];
            }
            return colors[0];
        }

        const infoBox = document.getElementById('info-box');
        function updateInfoBox(name) {
            const data = riskMap[name];
            if (!data) {
                infoBox.innerHTML = `<h3>${name}</h3><div>No data available for this municipality.</div>`;
                return;
            }
            let html = `<h3>${name}</h3><ul>`;
            // Display selected metric first, then others
            if (data[selectedMetric] !== undefined) {
                const label = selectedMetric.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                const displayVal = typeof data[selectedMetric] === 'number' ? data[selectedMetric].toFixed(2) : data[selectedMetric];
                html += `<li><strong>${label}:</strong> ${displayVal}</li>`;
            }
            Object.entries(data).forEach(([key,val]) => {
                if (key === selectedMetric) return; // Already displayed
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                const display = typeof val === 'number' ? val.toFixed(2) : val;
                html += `<li><strong>${label}:</strong> ${display}</li>`;
            });
            html += '</ul>';
            infoBox.innerHTML = html;
        }

        let geoLayer;
        function renderLayer() {
            const values = getMetricValues(selectedMetric);
            thresholds = computeThresholds(values);

            if (geoLayer) map.removeLayer(geoLayer);
            geoLayer = L.geoJSON(shapes, {
                style: feat => {
                    const val = riskMap[feat.properties.NAME]?.[selectedMetric];
                    return { 
                        fillColor: getColor(val), 
                        color: 'black', 
                        weight: isLight ? 1 : 1.5, // Thinner lines for light mode, slightly thicker for dark
                        fillOpacity:0.8,
                        opacity: isLight ? 0.5 : 0.7
                    };
                },
                onEachFeature: (feat,layer) => {
                    const name = feat.properties.NAME;
                    const val = riskMap[name]?.[selectedMetric];
                    const displayVal = (val !== null && val !== undefined && typeof val === 'number') ? val.toFixed(1) : 'N/A';
                    layer.bindTooltip(`${name}: ${displayVal}`);
                    layer.on('click', () => updateInfoBox(name));
                }
            }).addTo(map);

            // Update legend
            document.querySelector('.scale-container').innerHTML =
                colors.map(c => `<div class="scale-box" style="background:${c}"></div>`).join('');
            
            if (thresholds.length > 0 && values.length > 0) { // Check if thresholds and values are valid
                document.querySelector('.scale-labels').innerHTML =
                    ['≤', ...thresholds].map((t,i) => {
                        if (i === 0) {
                            return `<div>≤${thresholds[0] !== undefined ? thresholds[0].toFixed(1) : 'N/A'}</div>`;
                        } else {
                            return `<div>>${thresholds[i-1] !== undefined ? thresholds[i-1].toFixed(1) : 'N/A'}</div>`;
                        }
                    }).join('');
            } else { // Fallback if no data for legend
                 document.querySelector('.scale-labels').innerHTML = '<div>N/A</div>';
            }
        }

        metricSelect.addEventListener('change', () => {
            selectedMetric = metricSelect.value;
            renderLayer();
            infoBox.innerHTML = '<h3>Municipality Info</h3><div>Select a municipality on the map to see details here.</div>';
        });

        // Initial draw
        renderLayer();

        // Dark-mode toggle
        function toggleMode() {
            window.location.href = `?light_mode=${!isLight}`;
        }
        // No need for the second event listener for toggle-button icon change, 
        // as the page reloads and Django template handles the icon class.
        // If you want instant icon change without reload, you'd keep it and prevent default form submission.
    </script>
</body>
</html>